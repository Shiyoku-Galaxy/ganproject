name: Daily → Notion (Final Synced 2025-11)

on:
  workflow_dispatch: {}
  schedule:
    # UTC 00:05（JST 09:05）
    - cron: "5 0 * * *"

permissions: {}

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Post a daily log to Notion DB (auto-detect title key)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_VERSION: ${{ secrets.NOTION_VERSION }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          set -euo pipefail
          DATE=$(date -u +%Y-%m-%d)

          # 1) DBのタイトル列キーをAPIで自動取得（Actionsランナーにはjqが入っています）
          TITLE_KEY=$(
            curl -sS \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Notion-Version: $NOTION_VERSION" \
              "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID" \
            | jq -r '.properties | to_entries[] | select(.value.type=="title") | .key'
          )
          echo "TITLE_KEY=${TITLE_KEY}"
          export TITLE_KEY

          # 2) 送信用JSON（プロパティ名はあなたのDBに合わせています：日付/Status/Source）
          #    タイトル列名は自動検出した TITLE_KEY を使用
          jq -n \
            --arg dbid  "$NOTION_DATABASE_ID" \
            --arg date  "$DATE" \
            --arg title "$DATE Daily Log (GitHub)" \
            '
            {
              parent: { database_id: $dbid },
              properties:
                {
                  "日付":    { "date":   { "start": $date } },
                  "Status":  { "status": { "name": "未着手" } },
                  "Source":  { "multi_select": [ { "name": "GitHub" } ] }
                }
            } as $base
            | $base
            | .properties[env.TITLE_KEY] = { "title": [ { "text": { "content": $title } } ] }
            ' > payload.json

          echo "=== Sending Payload to Notion ==="
          # レスポンス本文はresponse.jsonに保存し、HTTPコードで成否判定
          HTTP_CODE=$(
            curl --fail-with-body -sS -o response.json -w '%{http_code}' \
              -X POST "https://api.notion.com/v1/pages" \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Notion-Version: $NOTION_VERSION" \
              -H "Content-Type: application/json" \
              -d @payload.json || true
          )
          echo "HTTP code: $HTTP_CODE"
          echo "Response:"; cat response.json || true

          # 2xx 以外は失敗扱い
          [[ "$HTTP_CODE" =~ ^2 ]] || exit 1

          [[ "$HTTP_CODE" =~ ^2 ]] || exit 1
