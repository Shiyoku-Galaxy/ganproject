name: Daily → Notion (Final)

on:
  workflow_dispatch: {}
  # 任意でスケジュール
  #schedule:
  #  - cron: '5 0 * * *'  # JST 09:05

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Post a daily log to Notion DB (no jq, no auto-detect)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_VERSION: ${{ secrets.NOTION_VERSION }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          set -euo pipefail

          # 1) 日付（UTC）→ YYYY-MM-DD
          DATE=$(date -u +%Y-%m-%d)

          # 2) Notion ペイロード（あなたのDB列名に直書き）
          #    - タイトル列名: Log Title  ← スクショと同じ表記
          #    - 日付列名: 日付
          #    - ステータス列名: Status（値: 未着手）
          #    - マルチセレクト列名: Source（値: GitHub）
          #    - チェックボックス列名: AutoSync
          read -r -d '' PAYLOAD <<'JSON'
          {
            "parent": { "database_id": "DBID" },
            "properties": {
              "Log Title": { "title": [ { "text": { "content": "DATE_DAILY Daily Log (GitHub)" } } ] },
              "日付":      { "date":  { "start": "DATESTR" } },
              "Status":    { "status": { "name": "未着手" } },
              "Source":    { "multi_select": [ { "name": "GitHub" } ] },
              "AutoSync":  { "checkbox": true }
            }
          }
          JSON

          # 3) 置換（DBID/DATE）
          PAYLOAD=${PAYLOAD/DBID/${NOTION_DATABASE_ID}}
          PAYLOAD=${PAYLOAD/DATESTR/${DATE}}
          PAYLOAD=${PAYLOAD/DATE_DAILY/${DATE}}

          echo "=== Sending Payload to Notion ==="
          echo "$PAYLOAD" | sed 's/"Authorization": "[^"]*"/"Authorization": "***"/g' >/dev/null  # 表示抑制

          # 4) 送信（2xx 以外は失敗）
          HTTP_CODE=$(
            curl --fail-with-body -sS -o response.json -w '%{http_code}' \
              -X POST "https://api.notion.com/v1/pages" \
              -H "Authorization: Bearer ${NOTION_TOKEN}" \
              -H "Notion-Version: ${NOTION_VERSION}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" || true
          )

          echo "HTTP code: ${HTTP_CODE}"
          echo "Response:"; cat response.json || true

          [[ "${HTTP_CODE}" =~ ^2 ]] || exit 1
